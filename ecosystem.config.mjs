// ============================================================================
// PM2 Ecosystem 配置文件
// 量化交易系统的 PM2 集群部署配置
// 自动适应 4~8 核 CPU，支持零宕机重载
// ============================================================================

// 导入 Node.js 操作系统模块（获取 CPU 核心数）
import * as os from 'os';
// 导入 Node.js 路径模块
import * as path from 'path';
// 导入 Node.js URL 模块（用于获取当前目录）
import { fileURLToPath } from 'url';

// ============================================================================
// 路径配置
// ============================================================================

// 获取当前文件目录（ES 模块兼容方式）
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// 项目根目录
const PROJECT_ROOT = __dirname;

// 日志目录
const LOG_DIR = path.join(PROJECT_ROOT, 'logs');

// 入口脚本
const ENTRY_SCRIPT = path.join(PROJECT_ROOT, 'dist', 'index.js');

// ============================================================================
// 实例数计算
// ============================================================================

// 获取 CPU 核心数
const cpuCount = os.cpus().length;

// 计算实例数（最少 4 个，最多 8 个）
// 根据实际 CPU 核心数自动调整
const instanceCount = Math.max(4, Math.min(8, cpuCount));

// 记录实例数配置
console.log(`[PM2 Config] CPU 核心数: ${cpuCount}，配置实例数: ${instanceCount}`);

// ============================================================================
// 环境变量配置
// ============================================================================

// 基础环境变量（所有环境通用）
const baseEnv = {
  // 运行模式
  CLUSTER_MODE: 'true',
  // 实例数量
  CLUSTER_INSTANCES: String(instanceCount),
  // 启用优雅关闭
  GRACEFUL_SHUTDOWN: 'true',
  // 热加载策略目录
  HOT_RELOAD_DIR: './strategies',
  // 监控端口
  MONITOR_PORT: '9090',
};

// 生产环境变量
const productionEnv = {
  // 设置 Node 环境
  NODE_ENV: 'production',
  // 日志级别
  LOG_LEVEL: 'info',
  // 合并基础环境变量
  ...baseEnv,
};

// 开发环境变量
const developmentEnv = {
  // 设置 Node 环境
  NODE_ENV: 'development',
  // 日志级别
  LOG_LEVEL: 'debug',
  // 合并基础环境变量
  ...baseEnv,
};

// ============================================================================
// PM2 应用配置
// ============================================================================

// 主应用配置
const mainApp = {
  // ========================================================================
  // 基础配置
  // ========================================================================

  // 应用名称（PM2 进程列表中显示）
  name: 'quant-trading',

  // 入口脚本路径
  script: ENTRY_SCRIPT,

  // 工作目录
  cwd: PROJECT_ROOT,

  // ========================================================================
  // 集群模式配置
  // ========================================================================

  // 实例数量（4~8 核自动适应）
  instances: instanceCount,

  // 执行模式：集群模式（支持多进程负载均衡）
  exec_mode: 'cluster',

  // ========================================================================
  // 环境变量配置
  // ========================================================================

  // 默认环境变量
  env: productionEnv,

  // 生产环境变量（pm2 start --env production）
  env_production: productionEnv,

  // 开发环境变量（pm2 start --env development）
  env_development: developmentEnv,

  // ========================================================================
  // 日志配置
  // ========================================================================

  // 输出日志文件
  out_file: path.join(LOG_DIR, 'quant-trading-out.log'),

  // 错误日志文件
  error_file: path.join(LOG_DIR, 'quant-trading-error.log'),

  // 合并日志文件（所有实例的日志合并到一个文件）
  log_file: path.join(LOG_DIR, 'quant-trading-combined.log'),

  // 日志时间格式
  log_date_format: 'YYYY-MM-DD HH:mm:ss.SSS',

  // 合并日志（集群模式下所有实例日志合并）
  merge_logs: true,

  // 启用时间戳
  time: true,

  // ========================================================================
  // 内存和性能配置
  // ========================================================================

  // 最大内存限制（超过则自动重启）
  // 2GB 适合处理大量交易数据
  max_memory_restart: '2G',

  // Node.js 运行参数
  node_args: [
    // 增加堆内存限制
    '--max-old-space-size=2048',
    // 启用 source map 支持
    '--enable-source-maps',
  ],

  // ========================================================================
  // 重启和恢复配置
  // ========================================================================

  // 启用自动重启
  autorestart: true,

  // 最大重启次数（超过后停止重启）
  max_restarts: 10,

  // 重启延迟（毫秒）
  // 避免频繁重启导致系统不稳定
  restart_delay: 1000,

  // 最小运行时间（毫秒）
  // 如果进程启动后在此时间内崩溃，视为启动失败
  min_uptime: 5000,

  // 不稳定重启的等待时间（毫秒）
  // 如果进程反复崩溃，增加等待时间
  exp_backoff_restart_delay: 100,

  // ========================================================================
  // 优雅关闭配置（零宕机重载核心）
  // ========================================================================

  // 等待应用发送 ready 信号
  // 应用需要在启动完成后调用 process.send('ready')
  wait_ready: true,

  // 等待 ready 信号的超时时间（毫秒）
  // 如果超时，PM2 会认为应用已就绪
  listen_timeout: 10000,

  // 优雅关闭超时时间（毫秒）
  // PM2 发送 SIGINT 后，等待应用关闭的最长时间
  // 超时后会发送 SIGKILL 强制终止
  kill_timeout: 15000,

  // ========================================================================
  // 进程退出配置
  // ========================================================================

  // 正常退出码（这些退出码不会触发重启）
  stop_exit_codes: [0],

  // ========================================================================
  // 文件监控配置（可选）
  // ========================================================================

  // 是否监控文件变化（生产环境建议关闭，使用热加载替代）
  watch: false,

  // 忽略监控的文件/目录
  ignore_watch: [
    'node_modules',
    'logs',
    '.git',
    '*.log',
    '.hot-reload',
    'coverage',
    'dist',
  ],

  // ========================================================================
  // Source Map 支持
  // ========================================================================

  // 启用 source map 支持（用于错误堆栈映射到源码）
  source_map_support: true,
};

// ============================================================================
// 导出配置
// ============================================================================

// PM2 Ecosystem 配置对象
// 导出为 ES 模块默认导出
export default {
  // 应用列表
  apps: [mainApp],
};
